{% extends "base.html" %}

{% block title %}Food Memory Map - Deconstructionist Cookbook{% endblock %}

{% block head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<!-- MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<style>
    #memory-map {
        height: 600px;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        z-index: 1;
    }
    
    .memory-details-panel {
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
        height: 600px;
        overflow-y: auto;
    }
    
    .memory-details-panel:hover {
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .memory-stats-panel {
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        margin-top: 1.5rem;
    }
    
    .custom-marker {
        width: 35px;
        height: 35px;
        display: block;
        text-align: center;
        line-height: 35px;
        background-color: var(--secondary-color);
        color: white;
        border-radius: 50% 50% 50% 0;
        transform: rotate(-45deg);
        animation: marker-drop 0.5s ease-out;
        cursor: pointer;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }
    
    .custom-marker i {
        transform: rotate(45deg);
        display: inline-block;
    }
    
    .custom-marker:hover {
        background-color: var(--accent-color);
        transform: rotate(-45deg) scale(1.2);
        transition: all 0.3s ease;
    }
    
    @keyframes marker-drop {
        0% {
            transform: translateY(-100px) rotate(-45deg);
            opacity: 0;
        }
        60% {
            transform: translateY(5px) rotate(-45deg);
            opacity: 1;
        }
        100% {
            transform: translateY(0) rotate(-45deg);
        }
    }
    
    .map-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        background-color: rgba(255, 255, 255, 0.8);
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .memory-image-container {
        height: 200px;
        overflow: hidden;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .memory-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }
    
    .memory-image:hover {
        transform: scale(1.05);
    }
    
    .tech-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 30px;
        font-size: 0.8rem;
        background-color: rgba(44, 62, 80, 0.1);
        color: var(--text-color);
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .tech-badge i {
        margin-right: 0.25rem;
    }
    
    .memory-meta {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
        font-size: 0.9rem;
        color: var(--muted-text);
    }
    
    .memory-meta > div {
        margin-right: 1rem;
    }
    
    .memory-meta i {
        margin-right: 0.25rem;
    }
    
    .friend-memory {
        background-color: rgba(231, 76, 60, 0.05);
        border-left: 3px solid var(--secondary-color);
        padding: 1rem;
        border-radius: 0 8px 8px 0;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .friend-memory:hover {
        background-color: rgba(231, 76, 60, 0.1);
        transform: translateX(5px);
    }
    
    .stat-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border-color);
    }
    
    .stat-item:last-child {
        border-bottom: none;
    }
    
    .stat-value {
        font-weight: 700;
        color: var(--secondary-color);
    }
    
    #add-memory-btn {
        position: fixed;
        bottom: 90px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: var(--secondary-color);
        color: white;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 1000;
    }
    
    #add-memory-btn:hover {
        transform: scale(1.1) rotate(90deg);
        background-color: var(--accent-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-lg-8 offset-lg-2 text-center">
        <h2 class="mb-3">Food Memory Map</h2>
        <p class="lead">Explore your food memories geographically and discover the stories behind each location</p>
    </div>
</div>

<div class="row mb-5">
    <!-- Map Column -->
    <div class="col-lg-8 mb-4">
        <div class="position-relative">
            <!-- Loading Indicator -->
            <div id="map-loading" class="map-loading">
                <div class="loading-spinner mb-3"></div>
                <h5>Loading Your Food Memory Map</h5>
                <p class="text-muted">Preparing your culinary journey...</p>
            </div>
            
            <!-- The Map -->
            <div id="memory-map"></div>
        </div>
    </div>
    
    <!-- Details Column -->
    <div class="col-lg-4">
        <!-- Memory Details Panel -->
        <div class="memory-details-panel" id="memory-details">
            <div id="default-view">
                <h3 class="mb-4"><i class="fas fa-map-pin"></i> Memory Details</h3>
                <p class="text-muted">Click on any marker on the map to view the memory details.</p>
                
                <div class="text-center py-4">
                    <img src="{{ url_for('static', filename='images/map-illustration.svg') }}" 
                         alt="Map Illustration" 
                         class="img-fluid mb-4" 
                         style="max-width: 200px; opacity: 0.7;" 
                         onerror="this.src='https://via.placeholder.com/200?text=Select+A+Memory';this.onerror=null;">
                    
                    <h4>No Memory Selected</h4>
                    <p>Explore your food memories by clicking on pins across the map.</p>
                </div>
            </div>
            
            <div id="memory-view" style="display: none;">
                <h3 id="memory-title"></h3>
                
                <div class="memory-meta">
                    <div><i class="fas fa-map-marker-alt"></i> <span id="memory-location"></span></div>
                </div>
                
                <div id="memory-image-container" class="memory-image-container mb-3" style="display: none;">
                    <img id="memory-image" class="memory-image" src="" alt="Food Memory">
                </div>
                
                <p id="memory-description"></p>
                
                <div id="memory-voice-container" class="mb-3" style="display: none;">
                    <h5><i class="fas fa-microphone"></i> Voice Memory</h5>
                    <audio id="memory-voice" controls class="audio-controls"></audio>
                </div>
                
                <div id="friend-memories-container" class="mt-4" style="display: none;">
                    <h5><i class="fas fa-users"></i> Friend Memories</h5>
                    <div id="friend-memories-list"></div>
                </div>
                
                <div class="mt-4">
                    <button class="btn btn-outline-primary btn-block animated-button" id="add-friend-memory-btn">
                        <i class="fas fa-plus"></i> Add Your Memory to This Pin
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Memory Stats Panel -->
        <div class="memory-stats-panel">
            <h4 class="mb-3"><i class="fas fa-chart-bar"></i> Memory Statistics</h4>
            
            <div class="stat-item">
                <div class="stat-label">Total Memories</div>
                <div class="stat-value" id="total-memories">{{ memories|length }}</div>
            </div>
            
            <div class="stat-item">
                <div class="stat-label">Memories with Voice</div>
                <div class="stat-value" id="voice-memories">{{ memories|selectattr('has_voice', 'equalto', true)|list|length }}</div>
            </div>
            
            <div class="stat-item">
                <div class="stat-label">Friend Contributions</div>
                <div class="stat-value" id="friend-contributions">{{ memories|selectattr('has_friend_voices', 'equalto', true)|list|length }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Add Memory Button -->
<div id="add-memory-btn" title="Add New Food Memory">
    <i class="fas fa-plus"></i>
</div>

<!-- Friend Memory Modal -->
<div class="modal fade" id="friendMemoryModal" tabindex="-1" role="dialog" aria-labelledby="friendMemoryModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="friendMemoryModalLabel">Add Your Memory to This Pin</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="friendMemoryForm" method="POST" action="">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="friend_name">Your Name</label>
                        <input type="text" class="form-control" id="friend_name" name="friend_name" required>
                    </div>
                    <div class="form-group">
                        <label for="message">Your Memory or Message</label>
                        <textarea class="form-control" id="message" name="message" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Record Voice Message (Optional)</label>
                        <div class="voice-controls">
                            <button type="button" id="startFriendRecording" class="btn btn-outline-primary btn-sm animated-button">
                                <i class="fas fa-microphone"></i> Start
                            </button>
                            <button type="button" id="stopFriendRecording" class="btn btn-outline-danger btn-sm" disabled>
                                <i class="fas fa-stop"></i> Stop
                            </button>
                            <span id="friendRecordingStatus"></span>
                        </div>
                        <audio id="friendAudioPlayback" controls style="display: none; width: 100%; margin-top: 10px;"></audio>
                        <input type="hidden" id="friendVoiceBlob" name="voiceBlob">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary animated-button">Save Memory</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<!-- MarkerCluster JS -->
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the map
        const map = L.map('memory-map', {
            zoomControl: false // We'll add it manually in a better position
        }).setView([20, 0], 2);
        
        // Add zoom control to the top-right corner
        L.control.zoom({
            position: 'topright'
        }).addTo(map);
        
        // Add a beautiful tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
        
        // Create a marker cluster group for better performance with many markers
        const markers = L.markerClusterGroup({
            showCoverageOnHover: false,
            maxClusterRadius: 50,
            iconCreateFunction: function(cluster) {
                const count = cluster.getChildCount();
                return L.divIcon({
                    html: `<div class="cluster-icon">${count}</div>`,
                    className: 'custom-cluster',
                    iconSize: L.point(40, 40)
                });
            }
        });
        
        // Get memories data passed from Flask
        const memories = {{ memories | tojson }};
        console.log("Memories loaded:", memories.length);
        
        // Custom icon creation function
        function createCustomMarker(memory) {
            const hasVoice = memory.voice_note_path !== null;
            const hasFriendVoices = memory.friend_voices && memory.friend_voices.length > 0;
            
            // Choose icon based on memory attributes
            let iconClass = 'fas fa-utensils';
            if (hasVoice && hasFriendVoices) {
                iconClass = 'fas fa-comments';
            } else if (hasVoice) {
                iconClass = 'fas fa-microphone';
            } else if (hasFriendVoices) {
                iconClass = 'fas fa-users';
            }
            
            return L.divIcon({
                html: `<i class="${iconClass}"></i>`,
                className: 'custom-marker',
                iconSize: [35, 35],
                iconAnchor: [17, 35]
            });
        }
        
        // Add markers with staggered animation
        setTimeout(() => {
            memories.forEach(function(memory, index) {
                setTimeout(() => {
                    const marker = L.marker([memory.latitude, memory.longitude], {
                        icon: createCustomMarker(memory)
                    });
                    
                    // Create popup for quick info on hover
                    const popupContent = `<strong>${memory.name}</strong>`;
                    marker.bindPopup(popupContent);
                    
                    // Add click event to show memory details
                    marker.on('click', function() {
                        showMemoryDetails(memory);
                        map.flyTo([memory.latitude, memory.longitude], 13, {
                            animate: true,
                            duration: 1
                        });
                    });
                    
                    markers.addLayer(marker);
                }, index * 50); // Stagger marker creation for visual effect
            });
            
            map.addLayer(markers);
            
            // If there are memories, fit the map to show all markers
            if (memories.length > 0) {
                const bounds = [];
                memories.forEach(function(memory) {
                    bounds.push([memory.latitude, memory.longitude]);
                });
                
                map.fitBounds(bounds, {
                    padding: [50, 50],
                    maxZoom: 10
                });
            }
            
            // Hide loading indicator
            document.getElementById('map-loading').style.display = 'none';
        }, 800); // Short delay for the animation to be noticeable
        
        // Function to show memory details in the panel
        function showMemoryDetails(memory) {
            console.log("Showing details for memory:", memory.id);
            
            // Show memory view, hide default view
            document.getElementById('default-view').style.display = 'none';
            document.getElementById('memory-view').style.display = 'block';
            
            // Set memory title
            document.getElementById('memory-title').textContent = memory.name;
            
            // Set memory location
            document.getElementById('memory-location').textContent = 
                `${memory.latitude.toFixed(4)}, ${memory.longitude.toFixed(4)}`;
            
            // Set memory description
            document.getElementById('memory-description').textContent = memory.description;
            
            // Handle memory image if available
            const imageContainer = document.getElementById('memory-image-container');
            const memoryImage = document.getElementById('memory-image');
            if (memory.image_path) {
                memoryImage.src = `/${memory.image_path}`;
                imageContainer.style.display = 'block';
            } else {
                imageContainer.style.display = 'none';
            }
            
            // Handle voice recording if available
            const voiceContainer = document.getElementById('memory-voice-container');
            const memoryVoice = document.getElementById('memory-voice');
            if (memory.voice_note_path) {
                memoryVoice.src = `/${memory.voice_note_path}`;
                voiceContainer.style.display = 'block';
            } else {
                voiceContainer.style.display = 'none';
            }
            
            // Handle friend voices if available
            const friendContainer = document.getElementById('friend-memories-container');
            const friendList = document.getElementById('friend-memories-list');
            if (memory.friend_voices && memory.friend_voices.length > 0) {
                friendList.innerHTML = '';
                memory.friend_voices.forEach(function(friend) {
                    const friendDiv = document.createElement('div');
                    friendDiv.className = 'friend-memory';
                    
                    let friendHTML = `
                        <strong>${friend.name}</strong>
                        <audio controls class="mt-2" style="width: 100%;">
                            <source src="/${friend.voice_path}" type="audio/wav">
                            Your browser does not support the audio element.
                        </audio>
                    `;
                    
                    friendDiv.innerHTML = friendHTML;
                    friendList.appendChild(friendDiv);
                });
                friendContainer.style.display = 'block';
            } else {
                friendContainer.style.display = 'none';
            }
        }
        
        // Add Friend Memory button click event
        document.getElementById('add-friend-memory-btn').addEventListener('click', function() {
            $('#friendMemoryModal').modal('show');
        });
        
        // Friend voice recording functionality
        let friendMediaRecorder;
        let friendAudioChunks = [];
        
        document.getElementById('startFriendRecording').addEventListener('click', function() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    friendAudioChunks = [];
                    friendMediaRecorder = new MediaRecorder(stream);
                    
                    friendMediaRecorder.addEventListener('dataavailable', event => {
                        friendAudioChunks.push(event.data);
                    });
                    
                    friendMediaRecorder.addEventListener('stop', () => {
                        const audioBlob = new Blob(friendAudioChunks, { type: 'audio/mp3' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audio = document.getElementById('friendAudioPlayback');
                        audio.src = audioUrl;
                        audio.style.display = 'block';
                        
                        // Convert to base64 for form submission
                        const reader = new FileReader();
                        reader.readAsDataURL(audioBlob);
                        reader.onloadend = function() {
                            document.getElementById('friendVoiceBlob').value = reader.result;
                        };
                    });
                    
                    friendMediaRecorder.start();
                    document.getElementById('startFriendRecording').disabled = true;
                    document.getElementById('stopFriendRecording').disabled = false;
                    document.getElementById('friendRecordingStatus').innerHTML = '<span class="recording-indicator"></span> Recording...';
                })
                .catch(error => {
                    console.error('Error accessing microphone:', error);
                    alert('Could not access your microphone. Please check your browser permissions.');
                });
        });
        
        document.getElementById('stopFriendRecording').addEventListener('click', function() {
            if (friendMediaRecorder && friendMediaRecorder.state !== 'inactive') {
                friendMediaRecorder.stop();
                friendMediaRecorder.stream.getTracks().forEach(track => track.stop());
                document.getElementById('startFriendRecording').disabled = false;
                document.getElementById('stopFriendRecording').disabled = true;
                document.getElementById('friendRecordingStatus').textContent = 'Recording saved';
            }
        });
        
        // Navigate to Add Memory page when the floating button is clicked
        document.getElementById('add-memory-btn').addEventListener('click', function() {
            window.location.href = "{{ url_for('food_memory_diary') }}";
        });
    });
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Food Memory Map - Deconstructionist Cookbook{% endblock %}

{% block head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<!-- MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<style>
    #memory-map {
        height: 600px;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        z-index: 1;
    }
    
    .memory-details-panel {
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
        height: 600px;
        overflow-y: auto;
    }
    
    .memory-details-panel:hover {
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .memory-stats-panel {
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        margin-top: 1.5rem;
    }
    
    .custom-marker {
        width: 35px;
        height: 35px;
        display: block;
        text-align: center;
        line-height: 35px;
        background-color: var(--secondary-color);
        color: white;
        border-radius: 50% 50% 50% 0;
        transform: rotate(-45deg);
        animation: marker-drop 0.5s ease-out;
        cursor: pointer;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }
    
    .custom-marker i {
        transform: rotate(45deg);
        display: inline-block;
    }
    
    .custom-marker:hover {
        background-color: var(--accent-color);
        transform: rotate(-45deg) scale(1.2);
        transition: all 0.3s ease;
    }
    
    @keyframes marker-drop {
        0% {
            transform: translateY(-100px) rotate(-45deg);
            opacity: 0;
        }
        60% {
            transform: translateY(5px) rotate(-45deg);
            opacity: 1;
        }
        100% {
            transform: translateY(0) rotate(-45deg);
        }
    }
    
    .map-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        background-color: rgba(255, 255, 255, 0.8);
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .memory-image-container {
        height: 200px;
        overflow: hidden;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .memory-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }
    
    .memory-image:hover {
        transform: scale(1.05);
    }
    
    .tech-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 30px;
        font-size: 0.8rem;
        background-color: rgba(44, 62, 80, 0.1);
        color: var(--text-color);
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .tech-badge i {
        margin-right: 0.25rem;
    }
    
    .memory-meta {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
        font-size: 0.9rem;
        color: var(--muted-text);
    }
    
    .memory-meta > div {
        margin-right: 1rem;
    }
    
    .memory-meta i {
        margin-right: 0.25rem;
    }
    
    .friend-memory {
        background-color: rgba(231, 76, 60, 0.05);
        border-left: 3px solid var(--secondary-color);
        padding: 1rem;
        border-radius: 0 8px 8px 0;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .friend-memory:hover {
        background-color: rgba(231, 76, 60, 0.1);
        transform: translateX(5px);
    }
    
    .stat-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border-color);
    }
    
    .stat-item:last-child {
        border-bottom: none;
    }
    
    .stat-value {
        font-weight: 700;
        color: var(--secondary-color);
    }
    
    #add-memory-btn {
        position: fixed;
        bottom: 90px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: var(--secondary-color);
        color: white;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 1000;
    }
    
    #add-memory-btn:hover {
        transform: scale(1.1) rotate(90deg);
        background-color: var(--accent-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-lg-8 offset-lg-2 text-center">
        <h2 class="mb-3">Food Memory Map</h2>
        <p class="lead">Explore your food memories geographically and discover the stories behind each location</p>
    </div>
</div>

<div class="row mb-5">
    <!-- Map Column -->
    <div class="col-lg-8 mb-4">
        <div class="position-relative">
            <!-- Loading Indicator -->
            <div id="map-loading" class="map-loading">
                <div class="loading-spinner mb-3"></div>
                <h5>Loading Your Food Memory Map</h5>
                <p class="text-muted">Preparing your culinary journey...</p>
            </div>
            
            <!-- The Map -->
            <div id="memory-map"></div>
        </div>
    </div>
    
    <!-- Details Column -->
    <div class="col-lg-4">
        <!-- Memory Details Panel -->
        <div class="memory-details-panel" id="memory-details">
            <div id="default-view">
                <h3 class="mb-4"><i class="fas fa-map-pin"></i> Memory Details</h3>
                <p class="text-muted">Click on any marker on the map to view the memory details.</p>
                
                <div class="text-center py-4">
                    <img src="{{ url_for('static', filename='images/map-illustration.svg') }}" 
                         alt="Map Illustration" 
                         class="img-fluid mb-4" 
                         style="max-width: 200px; opacity: 0.7;" 
                         onerror="this.src='https://via.placeholder.com/200?text=Select+A+Memory';this.onerror=null;">
                    
                    <h4>No Memory Selected</h4>
                    <p>Explore your food memories by clicking on pins across the map.</p>
                </div>
            </div>
            
            <div id="memory-view" style="display: none;">
                <h3 id="memory-title"></h3>
                
                <div class="memory-meta">
                    <div><i class="fas fa-map-marker-alt"></i> <span id="memory-location"></span></div>
                </div>
                
                <div id="memory-image-container" class="memory-image-container mb-3" style="display: none;">
                    <img id="memory-image" class="memory-image" src="" alt="Food Memory">
                </div>
                
                <p id="memory-description"></p>
                
                <div id="memory-voice-container" class="mb-3" style="display: none;">
                    <h5><i class="fas fa-microphone"></i> Voice Memory</h5>
                    <audio id="memory-voice" controls class="audio-controls"></audio>
                </div>
                
                <div id="friend-memories-container" class="mt-4" style="display: none;">
                    <h5><i class="fas fa-users"></i> Friend Memories</h5>
                    <div id="friend-memories-list"></div>
                </div>
                
                <div class="mt-4">
                    <button class="btn btn-outline-primary btn-block animated-button" id="add-friend-memory-btn">
                        <i class="fas fa-plus"></i> Add Your Memory to This Pin
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Memory Stats Panel -->
        <div class="memory-stats-panel">
            <h4 class="mb-3"><i class="fas fa-chart-bar"></i> Memory Statistics</h4>
            
            <div class="stat-item">
                <div class="stat-label">Total Memories</div>
                <div class="stat-value" id="total-memories">{{ memories|length }}</div>
            </div>
            
            <div class="stat-item">
                <div class="stat-label">Memories with Voice</div>
                <div class="stat-value" id="voice-memories">{{ memories|selectattr('has_voice', 'equalto', true)|list|length }}</div>
            </div>
            
            <div class="stat-item">
                <div class="stat-label">Friend Contributions</div>
                <div class="stat-value" id="friend-contributions">{{ memories|selectattr('has_friend_voices', 'equalto', true)|list|length }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Add Memory Button -->
<div id="add-memory-btn" title="Add New Food Memory">
    <i class="fas fa-plus"></i>
</div>

<!-- Friend Memory Modal -->
<div class="modal fade" id="friendMemoryModal" tabindex="-1" role="dialog" aria-labelledby="friendMemoryModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="friendMemoryModalLabel">Add Your Memory to This Pin</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="friendMemoryForm" method="POST" action="">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="friend_name">Your Name</label>
                        <input type="text" class="form-control" id="friend_name" name="friend_name" required>
                    </div>
                    <div class="form-group">
                        <label for="message">Your Memory or Message</label>
                        <textarea class="form-control" id="message" name="message" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Record Voice Message (Optional)</label>
                        <div class="voice-controls">
                            <button type="button" id="startFriendRecording" class="btn btn-outline-primary btn-sm animated-button">
                                <i class="fas fa-microphone"></i> Start
                            </button>
                            <button type="button" id="stopFriendRecording" class="btn btn-outline-danger btn-sm" disabled>
                                <i class="fas fa-stop"></i> Stop
                            </button>
                            <span id="friendRecordingStatus"></span>
                        </div>
                        <audio id="friendAudioPlayback" controls style="display: none; width: 100%; margin-top: 10px;"></audio>
                        <input type="hidden" id="friendVoiceBlob" name="voiceBlob">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary animated-button">Save Memory</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<!-- MarkerCluster JS -->
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the map
        const map = L.map('memory-map', {
            zoomControl: false // We'll add it manually in a better position
        }).setView([20, 0], 2);
        
        // Add zoom control to the top-right corner
        L.control.zoom({
            position: 'topright'
        }).addTo(map);
        
        // Add a beautiful tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
        
        // Create a marker cluster group for better performance with many markers
        const markers = L.markerClusterGroup({
            showCoverageOnHover: false,
            maxClusterRadius: 50,
            iconCreateFunction: function(cluster) {
                const count = cluster.getChildCount();
                return L.divIcon({
                    html: `<div class="cluster-icon">${count}</div>`,
                    className: 'custom-cluster',
                    iconSize: L.point(40, 40)
                });
            }
        });
        
        // Get memories data passed from Flask
        const memories = {{ memories | tojson }};
        console.log("Memories loaded:", memories.length);
        
        // Custom icon creation function
        function createCustomMarker(memory) {
            const hasVoice = memory.has_voice;
            const hasFriendVoices = memory.has_friend_voices;
            
            // Choose icon based on memory attributes
            let iconClass = 'fas fa-utensils';
            if (hasVoice && hasFriendVoices) {
                iconClass = 'fas fa-comments';
            } else if (hasVoice) {
                iconClass = 'fas fa-microphone';
            } else if (hasFriendVoices) {
                iconClass = 'fas fa-users';
            }
            
            return L.divIcon({
                html: `<i class="${iconClass}"></i>`,
                className: 'custom-marker',
                iconSize: [35, 35],
                iconAnchor: [17, 35]
            });
        }
        
        // Add markers with staggered animation
        setTimeout(() => {
            memories.forEach(function(memory, index) {
                setTimeout(() => {
                    const marker = L.marker([memory.latitude, memory.longitude], {
                        icon: createCustomMarker(memory)
                    });
                    
                    // Create popup for quick info on hover
                    const popupContent = `<strong>${memory.name}</strong>`;
                    marker.bindPopup(popupContent);
                    
                    // Add click event to show memory details
                    marker.on('click', function() {
                        showMemoryDetails(memory);
                        map.flyTo([memory.latitude, memory.longitude], 13, {
                            animate: true,
                            duration: 1
                        });
                    });
                    
                    markers.addLayer(marker);
                }, index * 50); // Stagger marker creation for visual effect
            });
            
            map.addLayer(markers);
            
            // If there are memories, fit the map to show all markers
            if (memories.length > 0) {
                const bounds = [];
                memories.forEach(function(memory) {
                    bounds.push([memory.latitude, memory.longitude]);
                });
                
                map.fitBounds(bounds, {
                    padding: [50, 50],
                    maxZoom: 10
                });
            }
            
            // Hide loading indicator
            document.getElementById('map-loading').style.display = 'none';
        }, 800); // Short delay for the animation to be noticeable
        
        // Function to show memory details in the panel
        function showMemoryDetails(memory) {
            console.log("Showing details for memory:", memory.id);
            
            // Set memory title
            document.getElementById('memory-title').textContent = memory.name;
            
            // Set memory location
            document.getElementById('memory-location').textContent = 
                `${memory.latitude.toFixed(4)}, ${memory.longitude.toFixed(4)}`;
            
            // Set memory description
            document.getElementById('memory-description').textContent = memory.description;
            
            // Handle memory image if available
            const imageContainer = document.getElementById('memory-image-container');
            const memoryImage = document.getElementById('memory-image');
            if (memory.image_path) {
                memoryImage.src = `/${memory.image_path}`;
                imageContainer.style.display = 'block';
            } else {
                imageContainer.style.display = 'none';
            }
            
            // Handle voice recording if available
            const voiceContainer = document.getElementById('memory-voice-container');
            const memoryVoice = document.getElementById('memory-voice');
            if (memory.has_voice && memory.voice_path) {
                memoryVoice.src = `/${memory.voice_path}`;
                voiceContainer.style.display = 'block';
            } else {
                voiceContainer.style.display = 'none';
            }
            
            // Handle friend voices if available
            const friendContainer = document.getElementById('friend-memories-container');
            const friendList = document.getElementById('friend-memories-list');
            if (memory.has_friend_voices && memory.friend_voices && memory.friend_voices.length > 0) {
                friendList.innerHTML = '';
                memory.friend_voices.forEach(function(friend) {
                    const friendDiv = document.createElement('div');
                    friendDiv.className = 'friend-memory';
                    
                    let friendHTML = `
                        <strong>${friend.name} says:</strong>
                        <p>${friend.message || 'No written message'}</p>
                    `;
                    
                    if (friend.voice_path) {
                        friendHTML += `<audio controls src="/${friend.voice_path}" class="audio-controls"></audio>`;
                    }
                    
                    friendDiv.innerHTML = friendHTML;
                    friendList.appendChild(friendDiv);
                });
                
                friendContainer.style.display = 'block';
            } else {
                friendContainer.style.display = 'none';
            }
            
            // Set up the friend memory form action
            document.getElementById('friendMemoryForm').action = `/add_friend_memory/${memory.id}`;
            
            // Show the memory view and hide default view
            document.getElementById('default-view').style.display = 'none';
            document.getElementById('memory-view').style.display = 'block';
        }
        
        // Add Friend Memory button click event
        document.getElementById('add-friend-memory-btn').addEventListener('click', function() {
            $('#friendMemoryModal').modal('show');
        });
        
        // Friend voice recording functionality
        let friendMediaRecorder;
        let friendAudioChunks = [];
        
        document.getElementById('startFriendRecording').addEventListener('click', function() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    friendAudioChunks = [];
                    friendMediaRecorder = new MediaRecorder(stream);
                    
                    friendMediaRecorder.addEventListener('dataavailable', event => {
                        friendAudioChunks.push(event.data);
                    });
                    
                    friendMediaRecorder.addEventListener('stop', () => {
                        const audioBlob = new Blob(friendAudioChunks, { type: 'audio/mp3' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audio = document.getElementById('friendAudioPlayback');
                        audio.src = audioUrl;
                        audio.style.display = 'block';
                        
                        // Convert to base64 for form submission
                        const reader = new FileReader();
                        reader.readAsDataURL(audioBlob);
                        reader.onloadend = function() {
                            document.getElementById('friendVoiceBlob').value = reader.result;
                        };
                    });
                    
                    friendMediaRecorder.start();
                    document.getElementById('startFriendRecording').disabled = true;
                    document.getElementById('stopFriendRecording').disabled = false;
                    document.getElementById('friendRecordingStatus').innerHTML = '<span class="recording-indicator"></span> Recording...';
                })
                .catch(error => {
                    console.error('Error accessing microphone:', error);
                    alert('Could not access your microphone. Please check your browser permissions.');
                });
        });
        
        document.getElementById('stopFriendRecording').addEventListener('click', function() {
            if (friendMediaRecorder && friendMediaRecorder.state !== 'inactive') {
                friendMediaRecorder.stop();
                friendMediaRecorder.stream.getTracks().forEach(track => track.stop());
                document.getElementById('startFriendRecording').disabled = false;
                document.getElementById('stopFriendRecording').disabled = true;
                document.getElementById('friendRecordingStatus').textContent = 'Recording saved';
            }
        });
        
        // Navigate to Add Memory page when the floating button is clicked
        document.getElementById('add-memory-btn').addEventListener('click', function() {
            window.location.href = "{{ url_for('food_memory_diary') }}";
        });
    });
</script>
{% endblock %}
